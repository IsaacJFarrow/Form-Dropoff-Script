# Migration Guide: Cloudflare KV to Upstash Redis

This guide will help you migrate from Cloudflare Workers KV to Upstash Redis.

## Setup Steps

### 1. Create an Upstash Account

1. Go to [https://upstash.com/](https://upstash.com/)
2. Sign up for a free account (or log in if you already have one)

### 2. Create a Redis Database

1. In the Upstash dashboard, click **"Create database"**
2. Choose **"Redis"** as the database type
3. **Database name**: Choose a name like `whatifweb-form-tracker` or `form-dropoff-tracker` (this is just for your organization - it doesn't affect the URL)
4. Select your preferred region (choose one closest to your Cloudflare Pages region or your users)
5. Use the default settings (free tier)
6. Click **"Create"**

### 3. Get Your Credentials

After creating the database, Upstash will automatically generate:

- **REST URL** - Something like `https://usw1-xxxx-xxxx.upstash.io` (the URL is auto-generated based on your region)
- **REST Token** - A long authentication token

**Important**: The REST URL is automatically generated by Upstash - you don't get to choose it. It will include your region code (like `usw1`, `eu1`, etc.) followed by a unique identifier.

**Copy both of these** - you'll need them in the next step!

### 4. Configure Cloudflare Pages Environment Variables

1. Log in to your [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. Go to **Workers & Pages** → Select your Pages project
3. Go to **Settings** → **Environment Variables**
4. Add the following environment variables:

   - **Variable name**: `UPSTASH_REDIS_REST_URL`

     - **Value**: Your Upstash REST URL (e.g., `https://xxxx-xxxx.upstash.io`)

   - **Variable name**: `UPSTASH_REDIS_REST_TOKEN`
     - **Value**: Your Upstash REST Token

5. Make sure to set these for **Production** (and Preview if you want to test)
6. Click **Save**

### 5. (Optional) Remove Cloudflare KV Namespace Binding

**You don't have to do this**, but it's recommended to keep things clean:

1. In Cloudflare Pages project settings
2. Go to **Settings** → **Functions**
3. Remove the `form-db` KV namespace binding (it's no longer used by the code)

**Note**: Leaving the binding won't cause any errors since your code doesn't reference it anymore. You can remove it later if you prefer, or keep it if you want an easy way to switch back to KV temporarily.

### 6. Deploy Your Changes

1. Commit and push your code changes to your repository
2. Cloudflare Pages will automatically deploy the new version
3. Or manually trigger a deployment from the Cloudflare dashboard

## What Changed in the Code

### New Files

- `functions/api/upstash.js` - Upstash Redis client wrapper

### Modified Files

- `functions/api/[[path]].js` - Now uses Upstash Redis instead of KV

The API interface remains the same - your existing tracking code (`tracker.js`) doesn't need any changes!

## Free Tier Limits

Upstash Redis free tier includes:

- **10,000 commands per day** (across all operations)
- **256 MB storage**
- Daily reset at UTC 00:00

For your form tracking use case, this should be more than sufficient!

## Testing

After deployment:

1. Visit your form and interact with it to generate tracking events
2. Check your dashboard at `/api/data` to verify events are being stored
3. Monitor your Upstash dashboard to see command usage

## Troubleshooting

### Error: "Upstash Redis credentials not configured"

- Verify environment variables are set correctly in Cloudflare Pages
- Make sure variable names are exactly: `UPSTASH_REDIS_REST_URL` and `UPSTASH_REDIS_REST_TOKEN`
- Redeploy after adding environment variables

### Error: "Upstash Redis error: 401"

- Check that your REST token is correct (no extra spaces)
- Verify the token hasn't been regenerated in Upstash dashboard

### Error: "Upstash Redis error: Rate limit exceeded"

- You've exceeded the free tier limit (10,000 commands/day)
- Wait for the daily reset or upgrade to a paid plan

## Migration Complete!

Once you've completed these steps, your form tracker will be using Upstash Redis instead of Cloudflare KV, and you won't have any dependency on Cloudflare's KV service!

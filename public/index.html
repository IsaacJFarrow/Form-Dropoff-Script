<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Drop-off Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; padding: 2em; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 900px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; margin-bottom: 1rem; }
        .controls { text-align: right; margin-bottom: 1rem; }
        .controls label { margin-right: 0.5rem; }
        .stats { display: flex; justify-content: space-around; text-align: center; margin-bottom: 2rem; }
        .stat-card { padding: 1rem; border-radius: 8px; background-color: #f8f9fa; flex-basis: 30%; }
        .stat-card h3 { margin: 0 0 0.5rem 0; color: #6c757d; text-transform: uppercase; font-size: 0.9rem; }
        .stat-card p { margin: 0; font-size: 2rem; font-weight: bold; color: #212529; }
        .tabs { overflow: hidden; border-bottom: 1px solid #dee2e6; margin-bottom: 1rem; }
        .tab-link { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 1rem; border-bottom: 2px solid transparent; }
        .tab-link:hover { border-bottom: 2px solid #ddd; }
        .tab-link.active { font-weight: bold; border-bottom: 2px solid #0d6efd; }
        .tab-content { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
        tbody tr:nth-child(odd) { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Onboarding Analysis</h1>

        <div class="controls">
            <label for="dateRange">Date Range:</label>
            <select id="dateRange">
                <option value="all">All Time</option>
                <option value="1">Last 24 Hours</option>
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
            </select>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>Form Views</h3>
                <p id="totalViews">0</p>
            </div>
            <div class="stat-card">
                <h3>Submissions</h3>
                <p id="totalSubmissions">0</p>
            </div>
            <div class="stat-card">
                <h3>Conversion Rate</h3>
                <p id="completionRate">0%</p>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'Funnel')">Funnel Chart</button>
            <button class="tab-link" onclick="openTab(event, 'Submissions')">Submissions Log</button>
            <button class="tab-link" onclick="openTab(event, 'PieChart')">Event Breakdown</button>
        </div>

        <div id="Funnel" class="tab-content" style="display: block;">
            <canvas id="funnelChart"></canvas>
        </div>

        <div id="PieChart" class="tab-content">
            <canvas id="pieChart"></canvas>
        </div>
    
        <div id="Submissions" class="tab-content">
            <table id="submissionsTable">
                <thead>
                    <tr>
                        <th>Submission Timestamp</th>
                        <th>Session ID</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        const funnelCtx = document.getElementById('funnelChart').getContext('2d');
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        Chart.register(ChartDataLabels);

        const funnelChart = new Chart(funnelCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Users Reached Step',
                    data: [],
                    backgroundColor: '#28a745',
                    order: 2,
                    datalabels: {
                        color: 'white',
                        anchor: 'center',
                        align: 'center',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        formatter: (value, context) => {
                            const dataset = context.chart.data.datasets[0].data;
                            if (context.dataIndex === 0) return null;
                            const prevValue = dataset[context.dataIndex - 1];
                            if (prevValue === 0) return null;
                            const dropOff = ((prevValue - value) / prevValue) * 100;
                            return dropOff > 0 ? `${dropOff.toFixed(0)}%` : null;
                        }
                    }
                },
                {
                    type: 'line',
                    label: 'Funnel Flow',
                    data: [],
                    borderColor: '#6c757d',
                    backgroundColor: '#6c757d',
                    tension: 0,
                    order: 1,
                    datalabels: {
                        display: false
                    }
                }]
            },
            options: {
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'Number of Users' },
                        ticks: {
                            precision: 0
                        }
                    },
                    x: { 
                        title: { display: true, text: 'Form Step' }
                    }
                }
            }
        });

        const pieChart = new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Breakdown of Tracking Events by Type'
                    }
                }
            },
        });

        async function updateDashboard() {
            try {
                const response = await fetch('/api/data');
                let rawData = await response.json();

                // --- Date Range Filter Logic ---
                const dateRange = document.getElementById('dateRange').value;
                if (dateRange !== 'all') {
                    const days = parseInt(dateRange, 10);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    
                    rawData = rawData.filter(event => {
                        const eventDate = new Date(event.timestamp);
                        return eventDate >= cutoffDate;
                    });
                }
                
                // --- KPI & Chart Logic ---
                const sessions = {};
                rawData.forEach(event => {
                    const { sessionId, step, event: eventType } = event;
                    if (!sessionId) return;
                    if (!sessions[sessionId]) {
                        sessions[sessionId] = { maxStep: 0, submitted: false };
                    }
                    if (eventType === 'stepChange' && step) {
                        const stepNum = parseInt(step, 10);
                        if (stepNum > sessions[sessionId].maxStep) sessions[sessionId].maxStep = stepNum;
                    } else if (eventType === 'formSubmission') {
                        sessions[sessionId].submitted = true;
                    }
                });

                const maxStep = Object.values(sessions).reduce((max, s) => Math.max(max, s.maxStep), 0);
                const hasSubmissions = Object.values(sessions).some(s => s.submitted);
                
                const labels = Array.from({ length: maxStep }, (_, i) => `Onboarding Step ${i + 1}`);
                if (hasSubmissions) labels.push('Submitted');
                
                const counts = Array(labels.length).fill(0);
                Object.values(sessions).forEach(session => {
                    for (let i = 0; i < session.maxStep; i++) counts[i]++;
                    if (session.submitted && hasSubmissions) counts[maxStep]++;
                });
                
                funnelChart.data.labels = labels;
                funnelChart.data.datasets[0].data = counts;
                funnelChart.data.datasets[1].data = counts;
                funnelChart.update();

                // --- Pie Chart Logic ---
                const eventCounts = rawData.reduce((acc, event) => {
                    acc[event.event] = (acc[event.event] || 0) + 1;
                    return acc;
                }, {});

                pieChart.data.labels = Object.keys(eventCounts);
                pieChart.data.datasets[0].data = Object.values(eventCounts);
                pieChart.update();

                // --- Stats Card Logic ---
                const sessionIds = Object.keys(sessions);
                const totalViews = sessionIds.length;
                const totalSubmissions = Object.values(sessions).filter(s => s.submitted).length;
                const conversionRate = totalViews > 0 ? (totalSubmissions / totalViews) * 100 : 0;

                document.getElementById('totalViews').textContent = totalViews;
                document.getElementById('totalSubmissions').textContent = totalSubmissions;
                document.getElementById('completionRate').textContent = `${conversionRate.toFixed(1)}%`;

                // --- Table Logic ---
                const tableBody = document.querySelector("#submissionsTable tbody");
                tableBody.innerHTML = ''; // Clear old data
                const submissions = rawData
                    .filter(event => event.event === 'formSubmission')
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort descending

                submissions.forEach(event => {
                    const row = tableBody.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    cell1.textContent = new Date(event.timestamp).toLocaleString();
                    cell2.textContent = event.sessionId;
                });

            } catch (error) {
                console.error('Error fetching or updating dashboard:', error);
            }
        }

        document.getElementById('dateRange').addEventListener('change', updateDashboard);
        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html> 
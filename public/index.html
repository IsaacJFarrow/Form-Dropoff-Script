<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What IF Web - Multi Step Form Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; padding: 2em; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 900px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; margin-bottom: 4rem; }
        .controls { display: flex; justify-content: flex-end; margin-bottom: 1rem; }
        .data-info { text-align: right; color: #6c757d; font-size: 0.8rem; margin-top: -0.75rem; margin-bottom: 1rem; }
        .stats { display: flex; justify-content: space-around; text-align: center; margin-bottom: 2rem; }
        .stat-card { padding: 1rem; border-radius: 8px; background-color: #f8f9fa; flex-basis: 30%; }
        .stat-card h3 { margin: 0 0 0.5rem 0; color: #6c757d; text-transform: uppercase; font-size: 0.9rem; }
        .stat-card p { margin: 0; font-size: 2rem; font-weight: bold; color: #212529; }
        .tabs { overflow: hidden; border-bottom: 1px solid #dee2e6; margin-bottom: 1rem; }
        .tab-link { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 1rem; border-bottom: 2px solid transparent; }
        .tab-link:hover { border-bottom: 2px solid #ddd; }
        .tab-link.active { font-weight: bold; border-bottom: 2px solid #0d6efd; }
        .sub-tabs { overflow: hidden; border-bottom: 1px solid #e9ecef; margin-bottom: 1.5rem; padding: 0.5rem; }
        .sub-tab-link { background-color: transparent; float: left; border: none; outline: none; cursor: pointer; padding: 8px 12px; transition: 0.3s; font-size: 0.9rem; border-radius: 4px; margin-right: 0.5rem; }
        .sub-tab-link:hover { background-color: #e9ecef; }
        .sub-tab-link.active { background-color: #0d6efd; color: white; font-weight: 500; }
        .tab-content { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
        tbody tr:nth-child(odd) { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Onboarding Analysis</h1>
        
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'Current')">Current Funnel (3 Steps)</button>
            <button class="tab-link" onclick="openTab(event, 'Previous')">Previous Funnel (4 Steps)</button>
            <button class="tab-link" onclick="openTab(event, 'Analytics')">Analytics</button>
            <button class="tab-link" onclick="openTab(event, 'Submissions')">Submissions Log</button>
        </div>

        <div id="Current" class="tab-content" style="display: block;">
            <div style="margin-bottom: 1rem; display: none;">
                <label for="changeDate">Change Implementation Date:</label>
                <input type="date" id="changeDate" style="margin-left: 0.5rem; padding: 0.5rem;">
                <button onclick="updateFunnels()" style="margin-left: 0.5rem; padding: 0.5rem 1rem; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;">Update Date</button>
                <span style="margin-left: 1rem; color: #6c757d; font-size: 0.9rem;">Showing data from this date onwards</span>
            </div>
            
            <div class="stats" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <h3>Form Views</h3>
                    <p id="currentViews">0</p>
                </div>
                <div class="stat-card">
                    <h3>Submissions</h3>
                    <p id="currentSubmissions">0</p>
                </div>
                <div class="stat-card">
                    <h3>Conversion Rate</h3>
                    <p id="currentConversion">0%</p>
                </div>
            </div>
            
            <canvas id="currentChart"></canvas>
        </div>

        <div id="Previous" class="tab-content">
            <div style="margin-bottom: 1rem; padding: 1rem; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                <strong>Historical Data:</strong> This shows performance data from before the 3-step optimization was implemented (22/08/2025).
            </div>
            
            <div class="stats" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <h3>Form Views</h3>
                    <p id="previousViews">0</p>
                </div>
                <div class="stat-card">
                    <h3>Submissions</h3>
                    <p id="previousSubmissions">0</p>
                </div>
                <div class="stat-card">
                    <h3>Conversion Rate</h3>
                    <p id="previousConversion">0%</p>
                </div>
            </div>
            
            <canvas id="previousChart"></canvas>
        </div>

        <div id="Analytics" class="tab-content">
            <div class="sub-tabs">
                <button class="sub-tab-link active" onclick="openSubTab(event, 'FunnelAnalysis')">Funnel Analysis</button>
                <button class="sub-tab-link" onclick="openSubTab(event, 'MonthlyTrends')">Monthly Trends</button>
            </div>

            <div id="FunnelAnalysis" class="sub-tab-content" style="display: block;">
                <div class="controls" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <label for="monthPicker" style="font-size: 0.9rem; color: #6c757d;">Month:</label>
                        <select id="monthPicker" style="padding: 0.5rem; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.9rem;">
                            <option value="">All Months</option>
                        </select>
                    </div>
                </div>
                
                <div class="stats" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <h3>Form Views</h3>
                        <p id="totalViews">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Submissions</h3>
                        <p id="totalSubmissions">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Conversion Rate</h3>
                        <p id="completionRate">0%</p>
                    </div>
                </div>
                
                <canvas id="analyticsChart" style="margin-bottom: 2rem;"></canvas>
                
            </div>

            <div id="MonthlyTrends" class="sub-tab-content" style="display: none;">
                <div style="margin-bottom: 2rem;">
                    <h2 style="text-align: center; margin-bottom: 1rem; color: #495057;">Monthly Performance Trends</h2>
                    <p style="text-align: center; color: #6c757d; margin-bottom: 2rem;">Track form views and submissions over time to identify growth patterns and seasonal trends</p>
                </div>
                
                <div class="stats" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <h3>Total Months</h3>
                        <p id="totalMonths">0</p>
                    </div>
                <div class="stat-card">
                    <h3>Best Month (Views)</h3>
                    <p id="bestMonth">-</p>
                </div>
                    <div class="stat-card">
                        <h3>Avg Monthly Growth</h3>
                        <p id="avgGrowth">0%</p>
                    </div>
                </div>
                
                <canvas id="trendsChart" style="margin-bottom: 2rem;"></canvas>
                
                <div style="text-align: center; color: #6c757d;">
                    <p>Monthly trends show all available historical data</p>
                </div>
            </div>
        </div>
    
        <div id="Submissions" class="tab-content">
            <table id="submissionsTable">
                <thead>
                    <tr>
                        <th>Submission Timestamp</th>
                        <th>Session ID</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function openSubTab(evt, subTabName) {
            let i, subtabcontent, subtablinks;
            subtabcontent = document.getElementsByClassName("sub-tab-content");
            for (i = 0; i < subtabcontent.length; i++) {
                subtabcontent[i].style.display = "none";
            }
            subtablinks = document.getElementsByClassName("sub-tab-link");
            for (i = 0; i < subtablinks.length; i++) {
                subtablinks[i].className = subtablinks[i].className.replace(" active", "");
            }
            document.getElementById(subTabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        Chart.register(ChartDataLabels);

        // Initialize current and previous charts
        let currentChart, previousChart, analyticsChart, trendsChart;

        async function updateDashboard() {
            try {
                // Use production API when running locally for development
                const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                let allData;
                if (isLocal) {
                    try {
                        const response = await fetch('https://tracker.whatifweb.co.nz/api/data');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        allData = await response.json();
                    } catch (apiError) {
                        // Fallback to test data for local development
                        allData = [
                            {
                                event: 'formView',
                                sessionId: 'test-session-1',
                                timestamp: new Date(Date.now() - 60000).toISOString()
                            },
                            {
                                event: 'stepChange',
                                step: '1',
                                sessionId: 'test-session-1',
                                timestamp: new Date(Date.now() - 50000).toISOString()
                            },
                            {
                                event: 'stepChange',
                                step: '2',
                                sessionId: 'test-session-1',
                                timestamp: new Date(Date.now() - 40000).toISOString()
                            },
                            {
                                event: 'formSubmission',
                                sessionId: 'test-session-1',
                                timestamp: new Date(Date.now() - 30000).toISOString()
                            }
                        ];
                    }
                } else {
                    const response = await fetch('/api/data');
                    allData = await response.json();
                }
                
                // Store data globally for comparison function
                window.currentData = allData;
                
                // Populate month picker with available data
                populateMonthPicker(allData);
                
                // Apply enhanced date filtering
                let filteredData = applyDateFilters(allData);

                // --- KPI & Chart Logic ---
                const sessions = {};
                filteredData.forEach(event => {
                    const { sessionId, step, event: eventType } = event;
                    if (!sessionId) return;
                    if (!sessions[sessionId]) {
                        sessions[sessionId] = { maxStep: 0, submitted: false };
                    }
                    if (eventType === 'stepChange' && step) {
                        const stepNum = parseInt(step, 10);
                        if (stepNum > sessions[sessionId].maxStep) sessions[sessionId].maxStep = stepNum;
                    } else if (eventType === 'formSubmission') {
                        sessions[sessionId].submitted = true;
                    }
                });

                // Update funnel charts if they exist
                updateFunnels();
                
                // Update analytics chart
                updateAnalyticsChart(filteredData);
                
                // Update trends chart (always use all data for trends)
                updateTrendsChart(allData);

                // --- Stats Card Logic ---
                const sessionIds = Object.keys(sessions);
                const totalViews = sessionIds.length;
                const totalSubmissions = Object.values(sessions).filter(s => s.submitted).length;
                const conversionRate = totalViews > 0 ? (totalSubmissions / totalViews) * 100 : 0;

                document.getElementById('totalViews').textContent = totalViews;
                document.getElementById('totalSubmissions').textContent = totalSubmissions;
                document.getElementById('completionRate').textContent = `${conversionRate.toFixed(1)}%`;

                // --- Table Logic ---
                const tableBody = document.querySelector("#submissionsTable tbody");
                tableBody.innerHTML = ''; // Clear old data
                const submissions = filteredData
                    .filter(event => event.event === 'formSubmission')
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort descending

                submissions.forEach(event => {
                    const row = tableBody.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    cell1.textContent = new Date(event.timestamp).toLocaleString();
                    cell2.textContent = event.sessionId;
                });

            } catch (error) {
            }
        }

        
        // Initialize funnel charts
        function initializeFunnelCharts() {
            if (currentChart) currentChart.destroy();
            if (previousChart) previousChart.destroy();

            const chartConfig = {
                type: 'bar',
                data: { 
                    labels: [], 
                    datasets: [{
                        label: 'Users Reached Step',
                        data: [], 
                        backgroundColor: '#28a745',
                        order: 2,
                        datalabels: {
                            color: 'white',
                            anchor: 'center',
                            align: 'center',
                            font: { size: 16, weight: 'bold' },
                            formatter: (value, context) => {
                                const dataset = context.chart.data.datasets[0].data;
                                if (context.dataIndex === 0) return null;
                                const prevValue = dataset[context.dataIndex - 1];
                                if (prevValue === 0) return null;
                                const dropOff = ((prevValue - value) / prevValue) * 100;
                                return dropOff > 0 ? `${dropOff.toFixed(0)}%` : null;
                            }
                        }
                    },
                    {
                        type: 'line',
                        label: 'Funnel Flow',
                        data: [],
                        borderColor: '#6c757d',
                        backgroundColor: '#6c757d',
                        tension: 0,
                        order: 1,
                        datalabels: { display: false }
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Users' }, ticks: { precision: 0 } },
                        x: { title: { display: true, text: 'Form Step' } }
                    }
                }
            };

            currentChart = new Chart(document.getElementById('currentChart').getContext('2d'), {
                ...chartConfig,
                data: { 
                    ...chartConfig.data, 
                    datasets: chartConfig.data.datasets.map(ds => ({ ...ds, backgroundColor: ds.backgroundColor === '#28a745' ? '#28a745' : ds.backgroundColor }))
                }
            });

            previousChart = new Chart(document.getElementById('previousChart').getContext('2d'), {
                ...chartConfig,
                data: { 
                    ...chartConfig.data, 
                    datasets: chartConfig.data.datasets.map(ds => ({ ...ds, backgroundColor: ds.backgroundColor === '#28a745' ? '#dc3545' : ds.backgroundColor }))
                }
            });
        }

        function updateFunnels() {
            if (!window.currentData) return;
            
            const changeDateInput = document.getElementById('changeDate');
            if (!changeDateInput.value) return;

            const changeDate = new Date(changeDateInput.value);
            const allData = window.currentData;
            
            // Split data by change date
            const currentData = allData.filter(event => new Date(event.timestamp) >= changeDate);
            const previousData = allData.filter(event => new Date(event.timestamp) < changeDate);
            
            // Process current data (3 steps)
            const currentSessions = {};
            currentData.forEach(event => {
                const { sessionId, step, event: eventType } = event;
                if (!sessionId) return;
                if (!currentSessions[sessionId]) currentSessions[sessionId] = { maxStep: 0, submitted: false };
                if (eventType === 'stepChange' && step) {
                    const stepNum = parseInt(step, 10);
                    if (stepNum > currentSessions[sessionId].maxStep) currentSessions[sessionId].maxStep = stepNum;
                } else if (eventType === 'formSubmission') {
                    currentSessions[sessionId].submitted = true;
                }
            });
            
            // Process previous data (4 steps)
            const previousSessions = {};
            previousData.forEach(event => {
                const { sessionId, step, event: eventType } = event;
                if (!sessionId) return;
                if (!previousSessions[sessionId]) previousSessions[sessionId] = { maxStep: 0, submitted: false };
                if (eventType === 'stepChange' && step) {
                    const stepNum = parseInt(step, 10);
                    if (stepNum > previousSessions[sessionId].maxStep) previousSessions[sessionId].maxStep = stepNum;
                } else if (eventType === 'formSubmission') {
                    previousSessions[sessionId].submitted = true;
                }
            });
            
            // Update current stats
            const currentViews = Object.keys(currentSessions).length;
            const currentSubmissions = Object.values(currentSessions).filter(s => s.submitted).length;
            const currentConversion = currentViews > 0 ? (currentSubmissions / currentViews) * 100 : 0;
            
            document.getElementById('currentViews').textContent = currentViews;
            document.getElementById('currentSubmissions').textContent = currentSubmissions;
            document.getElementById('currentConversion').textContent = `${currentConversion.toFixed(1)}%`;
            
            // Update previous stats
            const previousViews = Object.keys(previousSessions).length;
            const previousSubmissionCount = Object.values(previousSessions).filter(s => s.submitted).length;
            const previousConversion = previousViews > 0 ? (previousSubmissionCount / previousViews) * 100 : 0;
            
            document.getElementById('previousViews').textContent = previousViews;
            document.getElementById('previousSubmissions').textContent = previousSubmissionCount;
            document.getElementById('previousConversion').textContent = `${previousConversion.toFixed(1)}%`;
            
            // Update current chart (3 steps + submission)
            if (currentChart) {
                const currentMaxStep = Math.max(...Object.values(currentSessions).map(s => s.maxStep), 3);
                const currentHasSubmissions = Object.values(currentSessions).some(s => s.submitted);
                
                const currentLabels = Array.from({ length: currentMaxStep }, (_, i) => `Step ${i + 1}`);
                if (currentHasSubmissions) currentLabels.push('Submitted');
                
                const currentCounts = Array(currentLabels.length).fill(0);
                Object.values(currentSessions).forEach(session => {
                    for (let i = 0; i < session.maxStep; i++) currentCounts[i]++;
                    if (session.submitted && currentHasSubmissions) currentCounts[currentMaxStep]++;
                });
                
                currentChart.data.labels = currentLabels;
                currentChart.data.datasets[0].data = currentCounts;
                currentChart.data.datasets[1].data = currentCounts;
                currentChart.update();
            }
            
            // Update previous chart (4 steps + submission)
            if (previousChart) {
                const previousMaxStep = Math.max(...Object.values(previousSessions).map(s => s.maxStep), 4);
                const previousHasSubmissions = Object.values(previousSessions).some(s => s.submitted);
                
                const previousLabels = Array.from({ length: previousMaxStep }, (_, i) => `Step ${i + 1}`);
                if (previousHasSubmissions) previousLabels.push('Submitted');
                
                const previousCounts = Array(previousLabels.length).fill(0);
                Object.values(previousSessions).forEach(session => {
                    for (let i = 0; i < session.maxStep; i++) previousCounts[i]++;
                    if (session.submitted && previousHasSubmissions) previousCounts[previousMaxStep]++;
                });
                
                previousChart.data.labels = previousLabels;
                previousChart.data.datasets[0].data = previousCounts;
                previousChart.data.datasets[1].data = previousCounts;
                previousChart.update();
            }
            
        }

        // Set default change date to when the 3-step form was actually implemented
        // This should be the fixed date when you made the changes (approximately 2 weeks ago)
        const implementationDate = new Date('2025-08-22'); // Adjust this to your actual implementation date
        document.getElementById('changeDate').value = implementationDate.toISOString().split('T')[0];

        // Initialize analytics chart
        function initializeAnalyticsChart() {
            if (analyticsChart) analyticsChart.destroy();
            
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            analyticsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Users Reached Step',
                        data: [],
                        backgroundColor: '#0d6efd',
                        order: 2,
                        datalabels: {
                            color: 'white',
                            anchor: 'center',
                            align: 'center',
                            font: { size: 14, weight: 'bold' },
                            formatter: (value, context) => {
                                const dataset = context.chart.data.datasets[0].data;
                                if (context.dataIndex === 0) return null;
                                const prevValue = dataset[context.dataIndex - 1];
                                if (prevValue === 0) return null;
                                const dropOff = ((prevValue - value) / prevValue) * 100;
                                return dropOff > 0 ? `${dropOff.toFixed(0)}%` : null;
                            }
                        }
                    },
                    {
                        type: 'line',
                        label: 'Funnel Flow',
                        data: [],
                        borderColor: '#6c757d',
                        backgroundColor: '#6c757d',
                        tension: 0,
                        order: 1,
                        datalabels: { display: false }
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Form Funnel Analysis'
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Number of Users' }, 
                            ticks: { precision: 0 } 
                        },
                        x: { title: { display: true, text: 'Form Step' } }
                    }
                }
            });
        }

        // Update analytics chart with current filtered data
        function updateAnalyticsChart(filteredData) {
            if (!analyticsChart || !filteredData) return;
            
            // Process sessions for analytics chart
            const sessions = {};
            filteredData.forEach(event => {
                const { sessionId, step, event: eventType } = event;
                if (!sessionId) return;
                if (!sessions[sessionId]) {
                    sessions[sessionId] = { maxStep: 0, submitted: false };
                }
                if (eventType === 'stepChange' && step) {
                    const stepNum = parseInt(step, 10);
                    if (stepNum > sessions[sessionId].maxStep) sessions[sessionId].maxStep = stepNum;
                } else if (eventType === 'formSubmission') {
                    sessions[sessionId].submitted = true;
                }
            });
            
            // Calculate funnel data
            const maxStep = Math.max(...Object.values(sessions).map(s => s.maxStep), 3);
            const hasSubmissions = Object.values(sessions).some(s => s.submitted);
            
            const labels = Array.from({ length: maxStep }, (_, i) => `Step ${i + 1}`);
            if (hasSubmissions) labels.push('Submitted');
            
            const counts = Array(labels.length).fill(0);
            Object.values(sessions).forEach(session => {
                for (let i = 0; i < session.maxStep; i++) counts[i]++;
                if (session.submitted && hasSubmissions) counts[maxStep]++;
            });
            
            analyticsChart.data.labels = labels;
            analyticsChart.data.datasets[0].data = counts;
            analyticsChart.data.datasets[1].data = counts;
            analyticsChart.update();
        }

        // Initialize trends chart
        function initializeTrendsChart() {
            if (trendsChart) trendsChart.destroy();
            
            const ctx = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Form Views',
                        data: [],
                        backgroundColor: 'rgba(13, 110, 253, 0.8)',
                        borderColor: '#0d6efd',
                        borderWidth: 1,
                        order: 1,
                        datalabels: {
                            color: '#000000',
                            anchor: 'end',
                            align: 'top',
                            font: { size: 12, weight: 'bold' },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    },
                    {
                        label: 'Form Submissions',
                        data: [],
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: '#28a745',
                        borderWidth: 1,
                        order: 2,
                        datalabels: {
                            color: '#000000',
                            anchor: 'end',
                            align: 'top',
                            font: { size: 12, weight: 'bold' },
                            formatter: (value) => value > 0 ? value : ''
                        }
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Performance Trends',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        // Calculate conversion rate for this month
                                        const views = context.parsed.y;
                                        const submissions = trendsChart.data.datasets[1].data[context.dataIndex];
                                        const rate = views > 0 ? ((submissions / views) * 100).toFixed(1) : 0;
                                        return `Conversion Rate: ${rate}%`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Events'
                            },
                            ticks: { precision: 0 }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Process data for monthly trends
        function processMonthlyTrends(allData) {
            const monthlyData = {};
            
            // Group data by month
            allData.forEach(event => {
                if (!event || !event.timestamp || !event.sessionId) return;
                
                const date = new Date(event.timestamp);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const monthLabel = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        label: monthLabel,
                        sessions: new Set(),
                        submissions: new Set()
                    };
                }
                
                // Track unique sessions (form views)
                if (event.event === 'formView' || event.event === 'stepChange') {
                    monthlyData[monthKey].sessions.add(event.sessionId);
                }
                
                // Track submissions
                if (event.event === 'formSubmission') {
                    monthlyData[monthKey].submissions.add(event.sessionId);
                }
            });
            
            // Convert to arrays and sort by month
            const sortedMonths = Object.keys(monthlyData)
                .sort((a, b) => a.localeCompare(b))
                .map(monthKey => ({
                    key: monthKey,
                    label: monthlyData[monthKey].label,
                    views: monthlyData[monthKey].sessions.size,
                    submissions: monthlyData[monthKey].submissions.size
                }));
            
            return sortedMonths;
        }

        // Update trends chart and stats
        function updateTrendsChart(allData) {
            if (!trendsChart || !allData) return;
            
            const monthlyTrends = processMonthlyTrends(allData);
            
            // Update chart data
            trendsChart.data.labels = monthlyTrends.map(month => month.label);
            trendsChart.data.datasets[0].data = monthlyTrends.map(month => month.views);
            trendsChart.data.datasets[1].data = monthlyTrends.map(month => month.submissions);
            trendsChart.update();
            
            // Update stats
            const totalMonths = monthlyTrends.length;
            const bestMonth = monthlyTrends.reduce((best, current) => 
                current.views > best.views ? current : best, 
                { views: 0, label: '-' }
            );
            
            // Calculate average growth rate
            let avgGrowth = 0;
            if (monthlyTrends.length > 1) {
                const growthRates = [];
                for (let i = 1; i < monthlyTrends.length; i++) {
                    const prev = monthlyTrends[i - 1].views;
                    const curr = monthlyTrends[i].views;
                    if (prev > 0) {
                        growthRates.push(((curr - prev) / prev) * 100);
                    }
                }
                if (growthRates.length > 0) {
                    avgGrowth = growthRates.reduce((sum, rate) => sum + rate, 0) / growthRates.length;
                }
            }
            
            document.getElementById('totalMonths').textContent = totalMonths;
            document.getElementById('bestMonth').textContent = bestMonth.label;
            document.getElementById('avgGrowth').textContent = `${avgGrowth >= 0 ? '+' : ''}${avgGrowth.toFixed(1)}%`;
        }

        // Track if month picker has been populated to avoid resetting selection
        let monthPickerInitialized = false;

        // Populate month picker with available months
        function populateMonthPicker(allData) {
            const monthPicker = document.getElementById('monthPicker');
            const currentSelection = monthPicker.value; // Preserve current selection
            const months = new Set();
            
            allData.forEach(event => {
                if (event && event.timestamp) {
                    const date = new Date(event.timestamp);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthLabel = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                    months.add(JSON.stringify({ key: monthKey, label: monthLabel }));
                }
            });
            
            // Clear existing options except "All Months"
            monthPicker.innerHTML = '<option value="">All Months</option>';
            
            // Sort months and add to picker
            const sortedMonths = Array.from(months)
                .map(m => JSON.parse(m))
                .sort((a, b) => b.key.localeCompare(a.key));
            
            sortedMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month.key;
                option.textContent = month.label;
                monthPicker.appendChild(option);
            });
            
            // Restore previous selection if it still exists, otherwise set default
            if (currentSelection && sortedMonths.some(month => month.key === currentSelection)) {
                monthPicker.value = currentSelection;
            } else if (!monthPickerInitialized) {
                // Only set default on first initialization
                const currentDate = new Date();
                const currentMonthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                const hasCurrentMonth = sortedMonths.some(month => month.key === currentMonthKey);
                
                if (hasCurrentMonth) {
                    monthPicker.value = currentMonthKey;
                } else if (sortedMonths.length > 0) {
                    // If current month doesn't exist in data, select the most recent month
                    monthPicker.value = sortedMonths[0].key;
                }
                monthPickerInitialized = true;
            }
        }

        // Enhanced date filtering
        function applyDateFilters(allData) {
            let filteredData = [...allData];
            
            // Check month picker
            const selectedMonth = document.getElementById('monthPicker').value;
            if (selectedMonth) {
                const [year, month] = selectedMonth.split('-');
                filteredData = allData.filter(event => {
                    if (!event || !event.timestamp) return false;
                    const eventDate = new Date(event.timestamp);
                    return eventDate.getFullYear() == year && (eventDate.getMonth() + 1) == month;
                });
            }
            
            return filteredData;
        }

        // Add event listeners for enhanced filtering
        document.getElementById('monthPicker').addEventListener('change', () => {
            updateDashboard();
        });

        updateDashboard();
        setInterval(updateDashboard, 5000);
        
        // Initialize funnel charts when page loads
        setTimeout(initializeFunnelCharts, 100);
        setTimeout(initializeAnalyticsChart, 100);
        setTimeout(initializeTrendsChart, 100);
    </script>
</body>
</html> 